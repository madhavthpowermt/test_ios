---
name: CI
"on": workflow_dispatch
jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup java
      - uses: actions/setup-java@v3
        with:
          java-version: "11"

      - name: Flutter get
        uses: subosito/flutter-action@v1
        with:
          flutter-version: 2.10.1
      - name: Start SSH session
        uses: luchihoratiu/debug-via-ssh@main
        with:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          SSH_PASS: ${{ secrets.SSH_PASS }}
          NGROK_REGION: in

      - name: setup new user
        run: |
          dscl . -create /Users/madhavth
          dscl . -create /Users/madhavth UserShell /bin/bash
          dscl . -create /Users/madhavth RealName "Joe Admin" 
          dscl . -create /Users/madhavth UniqueID "510"
          dscl . -create /Users/madhavth PrimaryGroupID 20
          dscl . -create /Users/madhavth NFSHomeDirectory /Users/madhavth
          dscl . -passwd /Users/madhavth ${{ secrets.SSH_PASS }}
          dscl . -append /Groups/admin GroupMembership madhavth
        shell: bash

      - name: Cleanup everything
        if: ${{ always() }}
        run: sudo /var/root/cleanup
